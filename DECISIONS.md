# Sobranie API documentation — decisions

All rationale and decisions from development. Single source of truth for why things work the way they do.

---

## Approach: LLM-driven API.md

- **Single artifact**: One `docs/API.md` regenerated from global + ops. Schemas, notes, conventions, per-operation docs.
- **Refinement**: Phase 2 only — md-only cleanup. No notes or request/response samples. For each operation: send global + op doc to LLM; get `new_global`, `new_op`, `raisePossibleIssueToHuman`. Sequential (one op at a time). Merge all `new_global` outputs; write docs incrementally so you can inspect during the run.
- **No bootstrap/generation of initial files**: global.md, ops/*.md, and config/generators.json are provided by us.
- **Claude only**: Anthropic Claude exclusively. No OpenAI.

---

## Refinement flow (Phase 2 only)

- **Input**: Existing markdown only — `docs/global.md` and `docs/ops/<Op>.md`. No pairs, no notes.
- **Process**: One LLM call per operation, sequential. Prompt instructs: global = enums, general API notes, common patterns; minimal, no duplication. Per-op = schemas from existing docs, op-specific notes; reference global $defs.
- **Output**: `new_global`, `new_op`, `raisePossibleIssueToHuman`. The first two are written immediately to docs. Issues are appended to `logs/<run_id>/issues_for_review.md` for human review — they are never applied automatically.
- **Incremental writes**: After each op, `docs/ops/<Op>.md` and `docs/global.md` (merged so far) are written. `docs/API.md` is regenerated only at the end.
- **Two scripts**: `refine_api_md.py` (main) and `refine_ops_cleanup.py` (temporary alternative; same behavior).

---

## Data quality and diversification

From analysis of collected data:

- **Success rate**: ~80% (345 successes vs 84 errors).
- **Low quality** (among successes): ~30 empty responses (TotalItems:0, Items:[], d:[]).
- **Duplicates**: Many pairs share identical requests (e.g. same languageId) and identical responses. Pure catalogs (GetAllGenders, GetAllApplicationTypes, LoadLanguage) yield redundant samples.
- **Macedonian only**: Use `languageId`/`LanguageId` = 1 (Macedonian) everywhere. No Albanian/Turkish variants.
- **Meaningful generators only**: Keep constant for methodName and known-good IDs; catalog and uuid_from_listing where they reliably get IDs; range for pagination. Avoid enum for language. Lower sample sizes for pure catalogs (1–2).

---

## API.md structure

- **Top**: Intro, calling conventions, operations table.
- **$defs**: Shared types (AspDate, UUID, LanguageId, etc.).
- **Common patterns**: Domain conventions.
- **Common request filters**: Usage notes for TypeId, StatusId, CommitteeId, StructureId, Page/Rows, etc. Deduplicate globally.
- **Common response keys**: Meaning/usage for TotalItems, Items, d, etc. Deduplicate globally.
- **Per-operation**: Notes, Request, Response. Add `### Notes` when filter/key notes are discovered.

---

## Widening and anyOf

LLM must only widen, never narrow:

- **Widening** = expand schemas to accept more values: add enum values, make fields optional (anyOf with null), add optional properties, use anyOf/union when a field has multiple types.
- **anyOf/union** = required when a field can have multiple shapes. Docs must validate every previously seen body.
- **Never** remove enum values, make optional fields required, or drop anyOf branches.

---

## Filter usage and key meanings

- Request filters: explain what each does, how it affects results, when to use/omit.
- Response keys: explain meaning and typical usage. Add to Common sections; deduplicate globally.

---

## Config

- **config/generators.json**: The one generator config. Macedonian-only, meaningful generators.
- **config/refine.json**: Model for refine. `model_apply: claude-haiku-4-5` (used). `model_notes` is legacy (Phase 1 removed).

---

## Split docs (token savings)

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation request/response, notes.
- **docs/API.md**: Regenerated by `build_api_md.py` from global + ops (for UX).
- Refine sends only global + relevant op file per call → smaller context. Returns structured `{new_global, new_op, raisePossibleIssueToHuman}`. Sequential, ~31 calls.

---

## Scripts

- **collect.py**: Send requests using generators, save to collected/. Uses cache. Logs to `logs/collect/<run_id>/`.
- **gather_pairs.py**: Flatten manifest pairs into collected/pairs.json; optionally run collect first (`--generate-more`). Logs to `logs/gather_pairs/<run_id>/`.
- **split_api_md.py**: One-time split of API.md → global.md + ops/*.md.
- **refine_api_md.py**: Phase 2 only — md-only cleanup. One LLM call per op, sequential. Writes incrementally. Issues to `logs/refine_api_md/<run_id>/issues_for_review.md`. Haiku 4.5.
- **refine_ops_cleanup.py**: Temporary alternative to refine_api_md; same behavior. Logs to `logs/refine_ops_cleanup/<run_id>/`.
- **build_api_md.py**: Regenerate API.md from global + ops. Called automatically by refine at the end.

---

## Prompts

- **apply_cleanup_md.txt**: Cleanup prompt for refine_api_md. Global + op only. Rules: enums in global, minimal, dedupe; per-op schemas from existing docs.
- **refine_ops_cleanup.txt**: Same idea for refine_ops_cleanup.
- **notes_from_pair.txt**: Legacy — notes from pairs (Phase 1 removed).
- **apply_notes_to_api_md.txt**: Legacy — apply notes (Phase 1 removed).

---

## Models and limits

- **Refine (Phase 2)**: claude-haiku-4-5. Structured output schema: `{new_global, new_op, raisePossibleIssueToHuman}`. Uses 20min timeout for large structured output to avoid "Streaming is required" error.
- **Cost**: ~$3.84 per full run (31 ops). ~39 min wall time.

---

## Routing

- **Standard**: `https://www.sobranie.mk/Routing/MakePostRequest` — POST, body includes methodName.
- **ASMX**: `GetCustomEventsCalendar`, `GetOfficialVisitsForUser` — different URLs, wrapped model.
- **Infrastructure**: `LoadLanguage` — `Infrastructure/LoadLanguage`, empty body.

---

## File layout

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation docs.
- **docs/API.md**: Regenerated by build_api_md from global + ops.
- **collected/{operation}/**: req_001.json, resp_001.json, etc.
- **collected/manifest.json**: Links req ↔ resp per run.
- **collected/pairs.json**: Flattened pairs (from gather_pairs); refine does not use this.
- **errors/{operation}/**: Failed requests.
- **logs/collect/**, **logs/gather_pairs/**, **logs/refine_api_md/**, **logs/refine_ops_cleanup/**: Run logs and `issues_for_review.md`.
- **config/refine.json**: Model for refine.
- **prompts/**: LLM prompt templates.

---

## Archive

Obsolete scripts, logs, caches, legacy docs, and schema-inference artifacts live in `archive/`. Structure preserved; new obsolete items are added, not reorganized.
