# Sobranie API documentation — decisions

All rationale and decisions from development. Single source of truth for why things work the way they do.

---

## Approach: LLM-driven API.md

- **Single artifact**: One `docs/API.md` regenerated from global + ops. Schemas, notes, conventions, per-operation docs.
- **Refinement loop**: Phase 1: notes for all pairs (5 parallel). Phase 2: group notes by op, chunk ops into 5, run 5 apply calls in parallel per chunk; merge 5 new_globals via concatenation; write docs; next chunk. Additive only.
- **No bootstrap/generation of initial files**: global.md, ops/*.md, and config/generators.json are provided by us.
- **Claude only**: Anthropic Claude exclusively. No OpenAI.

---

## Data quality and diversification

From analysis of collected data:

- **Success rate**: ~80% (345 successes vs 84 errors).
- **Low quality** (among successes): ~30 empty responses (TotalItems:0, Items:[], d:[]).
- **Duplicates**: Many pairs share identical requests (e.g. same languageId) and identical responses. Pure catalogs (GetAllGenders, GetAllApplicationTypes, LoadLanguage) yield redundant samples.
- **Macedonian only**: Use `languageId`/`LanguageId` = 1 (Macedonian) everywhere. No Albanian/Turkish variants.
- **Meaningful generators only**: Keep constant for methodName and known-good IDs; catalog and uuid_from_listing where they reliably get IDs; range for pagination. Avoid enum for language. Lower sample sizes for pure catalogs (1–2).

---

## API.md structure

- **Top**: Intro, calling conventions, operations table.
- **$defs**: Shared types (AspDate, UUID, LanguageId, etc.).
- **Common patterns**: Domain conventions.
- **Common request filters**: Usage notes for TypeId, StatusId, CommitteeId, StructureId, Page/Rows, etc. Deduplicate globally.
- **Common response keys**: Meaning/usage for TotalItems, Items, d, etc. Deduplicate globally.
- **Per-operation**: Notes, Request, Response. Add `### Notes` when filter/key notes are discovered.

---

## Widening and anyOf

LLM must only widen, never narrow:

- **Widening** = expand schemas to accept more values: add enum values, make fields optional (anyOf with null), add optional properties, use anyOf/union when a field has multiple types.
- **anyOf/union** = required when a field can have multiple shapes. Docs must validate every previously seen body.
- **Never** remove enum values, make optional fields required, or drop anyOf branches.

---

## Filter usage and key meanings

- Request filters: explain what each does, how it affects results, when to use/omit.
- Response keys: explain meaning and typical usage. Add to Common sections; deduplicate globally.

---

## Config

- **config/generators.json**: The one generator config. Macedonian-only, meaningful generators.
- **config/refine.json**: Model pairing for refine. Default: `model_notes: claude-sonnet-4-5`, `model_apply: claude-haiku-4-5`. Notes use smarter model; apply uses cheaper model with structured output.

---

## Split docs (token savings)

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation request/response, notes.
- **docs/API.md**: Regenerated by `build_api_md.py` from global + ops (for UX).
- Refine sends only global + relevant op file per apply → smaller context. Apply returns structured `{new_global, new_op}`. Bulk: one apply per op (all notes concatenated), ~31 apply calls vs 345 pairs.

---

## Scripts (simplified)

- **collect.py**: Send requests using generators, save to collected/. Uses cache.
- **gather_pairs.py**: Flatten manifest pairs; optionally run collect first (`--generate-more`).
- **split_api_md.py**: One-time split of API.md → global.md + ops/*.md.
- **refine_api_md.py**: Bulk refinement. Phase 1: notes for all pairs (5 parallel, `--parallel-notes`). Phase 2: group notes by op, chunk ops into 5 (`--chunk-size`), run 5 applies in parallel per chunk, merge 5 new_globals via section-wise concatenation (no LLM), write docs, next chunk. Notes: Sonnet 4.5. Apply: Haiku 4.5 with structured output.
- **build_api_md.py**: Regenerate API.md from global + ops. Called automatically by refine.

---

## Prompts

- **notes_from_pair.txt**: Extract notes from global+op+req+resp (one pair). Widening only, filter/key notes when useful.
- **apply_notes_to_api_md.txt**: Apply notes (single or concatenated) → structured `{new_global, new_op}`. Uses Anthropic structured output schema.

---

## Models and limits

- **Notes**: claude-sonnet-4-5 (smarter model, no structured output needed).
- **Apply**: claude-haiku-4-5 (structured output support, cheaper). Schema: `{new_global: string, new_op: string}`. Uses 20min timeout for large structured output to avoid "Streaming is required" error.

---

## Routing

- **Standard**: `https://www.sobranie.mk/Routing/MakePostRequest` — POST, body includes methodName.
- **ASMX**: `GetCustomEventsCalendar`, `GetOfficialVisitsForUser` — different URLs, wrapped model.
- **Infrastructure**: `LoadLanguage` — `Infrastructure/LoadLanguage`, empty body.

---

## File layout

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation docs.
- **docs/API.md**: Regenerated by build_api_md from global + ops.
- **collected/{operation}/**: req_001.json, resp_001.json, etc.
- **collected/manifest.json**: Links req ↔ resp per run.
- **errors/{operation}/**: Failed requests.
- **config/refine.json**: Model pairing for refine.
- **prompts/**: LLM prompt templates.

---

## Archive

Obsolete scripts, logs, caches, legacy docs, and schema-inference artifacts live in `archive/`. Structure preserved; new obsolete items are added, not reorganized.
