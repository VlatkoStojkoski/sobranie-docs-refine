# Sobranie API documentation — decisions

All rationale and decisions from development. Single source of truth for why things work the way they do.

---

## Approach: LLM-driven API.md

- **Single artifact**: One `docs/API.md` regenerated from global + ops. Schemas, notes, conventions, per-operation docs.
- **Refinement**: Md-only. For each operation: send global + op doc to LLM; get `global_modification_notes`, `new_op`, `raisePossibleIssueToHuman`. Write each `new_op` to docs immediately. After all ops, apply all modification notes in one batch to produce final `docs/global.md`. No request/response samples.
- **No bootstrap/generation of initial files**: global.md, ops/*.md, and config/generators.json are provided by us.
- **Claude only**: Anthropic Claude exclusively. No OpenAI.

---

## Refinement flow

- **Input**: Existing markdown only — `docs/global.md` and `docs/ops/<Op>.md`. No pairs, no notes.
- **Process**: One LLM call per operation, sequential. Per op: output global_modification_notes (concise instructions for global) and new_op (full op doc following template; specifics in op not global). After the loop, one batch LLM call applies all notes to produce final global.md.
- **Output**: Each `docs/ops/<Op>.md` written after its op. `docs/global.md` written once at the end. Issues to `logs/refine_ops_cleanup/<run_id>/issues_for_review.md`. `docs/API.md` regenerated at the end.
- **Single script**: `refine_ops_cleanup.py`.

---

## Data quality and diversification

From analysis of collected data:

- **Success rate**: ~80% (345 successes vs 84 errors).
- **Low quality** (among successes): ~30 empty responses (TotalItems:0, Items:[], d:[]).
- **Duplicates**: Many pairs share identical requests (e.g. same languageId) and identical responses. Pure catalogs (GetAllGenders, GetAllApplicationTypes, LoadLanguage) yield redundant samples.
- **Macedonian only**: Use `languageId`/`LanguageId` = 1 (Macedonian) everywhere. No Albanian/Turkish variants.
- **Meaningful generators only**: Keep constant for methodName and known-good IDs; catalog and uuid_from_listing where they reliably get IDs; range for pagination. Avoid enum for language. Lower sample sizes for pure catalogs (1–2).

---

## API.md structure

- **Top**: Intro, calling conventions, operations table.
- **$defs**: Shared types (AspDate, UUID, LanguageId, etc.).
- **Common patterns**: Domain conventions.
- **Common request filters**: Usage notes for TypeId, StatusId, CommitteeId, StructureId, Page/Rows, etc. Deduplicate globally.
- **Common response keys**: Meaning/usage for TotalItems, Items, d, etc. Deduplicate globally.
- **Per-operation**: Notes, Request, Response. Add `### Notes` when filter/key notes are discovered.

---

## Widening and anyOf

LLM must only widen, never narrow:

- **Widening** = expand schemas to accept more values: add enum values, make fields optional (anyOf with null), add optional properties, use anyOf/union when a field has multiple types.
- **anyOf/union** = required when a field can have multiple shapes. Docs must validate every previously seen body.
- **Never** remove enum values, make optional fields required, or drop anyOf branches.

---

## Filter usage and key meanings

- Request filters: explain what each does, how it affects results, when to use/omit.
- Response keys: explain meaning and typical usage. Add to Common sections; deduplicate globally.

---

## Config

- **config/generators.json**: The one generator config. Macedonian-only, meaningful generators.
- **config/refine.json**: `model_apply` — model for refine (e.g. claude-haiku-4-5).

---

## Split docs (token savings)

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation request/response, notes.
- **docs/API.md**: Regenerated by `build_api_md.py` from global + ops (for UX).
- Refine sends only global + relevant op file per call → smaller context. Per op returns `{global_modification_notes, new_op, raisePossibleIssueToHuman}`; notes are batched and applied once at the end. Sequential, ~31 op calls + 1 batch call.

---

## Scripts

- **collect.py**: Send requests using generators, save to collected/. Uses cache. Logs to `logs/collect/<run_id>/`.
- **gather_pairs.py**: Flatten manifest pairs into collected/pairs.json; optionally run collect first (`--generate-more`). Logs to `logs/gather_pairs/<run_id>/`. Refine does not use pairs.
- **refine_ops_cleanup.py**: Refine global + per-op docs. Processes every .md in docs/ops/ except OPERATION_TEMPLATE. Per-op modification notes, then batch apply for global. One LLM call per op + one batch call. Logs to `logs/refine_ops_cleanup/<run_id>/`. Calls build_api_md at the end.
- **build_api_md.py**: Regenerate API.md from global + ops (excludes OPERATION_TEMPLATE.md). Called automatically by refine at the end.

One-time migration script `split_api_md.py` is in `archive/scripts/` if needed.

---

## Prompts

- **refine_ops_cleanup.txt**: Prompt for refine_ops_cleanup. Global modification notes (batched later) + new_op (template, field details, specifics in op). Const for methodName; $ref only for enums.
- Legacy prompts (notes from pairs, apply notes) are in `archive/prompts_legacy/`.

---

## Models and limits

- **Refine**: claude-haiku-4-5. Per op: `{global_modification_notes, new_op, raisePossibleIssueToHuman}`. Batch: `{global_md}`.
- **Cost**: ~$3.84 per full run (31 ops). ~39 min wall time.

---

## Routing

- **Standard**: `https://www.sobranie.mk/Routing/MakePostRequest` — POST, body includes methodName.
- **ASMX**: `GetCustomEventsCalendar`, `GetOfficialVisitsForUser` — different URLs, wrapped model.
- **Infrastructure**: `LoadLanguage` — `Infrastructure/LoadLanguage`, empty body.

---

## File layout

- **docs/global.md**: Conventions, $defs, common filters/keys.
- **docs/ops/<Operation>.md**: Per-operation docs.
- **docs/API.md**: Regenerated by build_api_md from global + ops.
- **collected/{operation}/**: req_001.json, resp_001.json, etc.
- **collected/manifest.json**: Links req ↔ resp per run.
- **collected/pairs.json**: Flattened pairs (from gather_pairs); refine does not use this.
- **errors/{operation}/**: Failed requests.
- **logs/collect/**, **logs/gather_pairs/**, **logs/refine_ops_cleanup/**: Run logs; refine also writes `issues_for_review.md`.
- **config/refine.json**: Model for refine.
- **prompts/**: LLM prompt templates.

---

## Archive

Obsolete scripts, logs, caches, legacy docs, and schema-inference artifacts live in `archive/`. Structure preserved; new obsolete items are added, not reorganized.
